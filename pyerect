#!/usr/bin/python
# Copyright @ 2017 Michael P. Reilly. All rights reserved.

from pyerector import *
from pyerector.api import Subcommand, Task

ReleaseFiles = (
    'install.sh', 'LICENSE.txt', 'README.md', 'test.sh', 'ws.sh'
) + tuple(Path('plugins'))

WsDir = Path('build', 'workspaces')

class CleanTest(Clean):
    files = (WsDir + 'test.err', WsDir + 'test.log')

Packaging.tasks = (
    Tar('build/workspaces',
        root='build', name='dist/workspaces.tgz'),
)
Packaging.dependencies = (
    CleanTest,
)

class SpawnTask(Task):
    def run(self):
        prog = self.args[0]
        Subcommand( (prog,), wdir='build/workspaces' )

Compile.tasks = (
    Copy(*ReleaseFiles, dest='build/workspaces'),
)


Testonly.tasks = (
    SpawnTask('./test.sh'),
)
InitDirs.files = ( 'build/workspaces', 'dist' )
Clean.files = ( 'build', 'dist', 'test.err', 'test.log' )

class Bitbucket_Pipelines_Upload(Task):
    baseurl = 'https://api.bitbucket.org/2.0/repositories/%(user)s/%(slug)s/downloads'
    bb_creds = 'Arcege:eCV6DVbS8ZXa4D86ky6z'
    def run(self):
        import os, urllib2
        distfile = Path('dist', 'workspaces.tgz')
        basename = os.environ.get('BITBUCKET_REPO_SLUG', 'workspaces')
        if 'BITBUCKET_BOOKMARK' in os.environ:
            vers = os.environ['BITBUCKET_BOOKMARK'].replace('release-', '')
        elif 'BITBUCKET_BUILD_NUMBER' in os.environ:
            vers = 'b' + os.environ['BITBUCKET_BUILD_NUMBER']
        else:
            vers = 'SNAPSHOT'
        name = '%s-%s.tgz' % (basename, vers)
        url = self.baseurl % {
                'user': 'Arcege',
                'slug': 'workspaces'
        }
        newname = Path(distfile.dirname, name)
        distfile.copy(newname)
        cmd = (
            'curl', '-X', 'POST', '--user', self.bb_creds,
            url, '--form', 'files=@%s' % newname
        )
        Subcommand(cmd)

class Upload(Target):
    """Upload to bitbucket downloads."""
    dependencies = ( Dist, )
    tasks = ( Bitbucket_Pipelines_Upload, )

PyErector()
